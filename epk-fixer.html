<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>EPK fixer</title>
    <style>:root{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica Neue,Arial,Noto Sans}body{margin:0;padding:28px;background:#0b0e14;color:#e6e6e6}h1{font-size:20px;margin:0 0 10px}h2{font-size:18px;margin:0 0 10px}a{color:#a7b1c2;text-decoration:none}a:hover{text-decoration:underline}.app{max-width:860px;margin:0 auto;display:grid;gap:16px}header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}footer{max-width:860px;margin:24px auto 0;text-align:center;color:#a7b1c2;font-size:13px}.card{background:#111626;border:1px solid #1c2440;border-radius:14px;padding:16px;box-shadow:0 6px 18px #00000040}.row{display:grid;gap:16px}.drop{border:2px dashed #29407f;border-radius:14px;padding:26px;background:#0f1424;text-align:center}.drop.drag{background:#12204a}.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#1f2848;border:1px solid #33407a;font-size:12px}.muted{color:#a7b1c2;font-size:13px}.log{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;white-space:pre-wrap;background:#0f1424;padding:12px;border-radius:10px;border:1px solid #253157;max-height:240px;overflow:auto}input[type=file]{display:none}.btn{display:inline-flex;align-items:center;gap:8px;background:#2344ff;border:1px solid #2344ff;color:#fff;border-radius:10px;margin-top:5px;padding:10px 12px;cursor:pointer}
</style>
  </head>
  <body>
    <div class="app">
      <div class="card">
        <header>
          <h1>üõ†Ô∏è EPK fixer</h1>
          <span class="badge" id="engineStatus">Engine: not loaded</span>
        </header>
        <p class="muted">
          Drop an <code>.epk</code> anywhere below. We'll ensure <code>cert.txt</code> ends with a newline, then instantly download the fixed .epk file. All processing happens locally in your browser.
        </p>
        <div id="drop" class="drop">
          <strong>Drop .epk here</strong>
          <br /><span class="muted">or</span><br />
          <label class="btn" for="file">Choose file</label>
          <input id="file" type="file" accept=".epk" />
        </div>
      </div>
      <div class="card">
        <h2>Log</h2>
        <div id="log" class="log">Ready.</div>
      </div>
      <footer>
        &copy; 2025 <a href="mailto:alex@karlborgs.com">Alexander Schmidt</a>. This tool is provided as-is, without warranty of any kind. Use at your own risk.
      </footer>
    </div>
    <script type="module">function y(){try{return!(!("noModule"in document.createElement("script"))||typeof TextEncoder>"u"||typeof TextDecoder>"u"||typeof Uint8Array>"u"||typeof ArrayBuffer>"u"||typeof Blob>"u"||typeof URL>"u"||typeof URL.createObjectURL!="function"||typeof File>"u"||!("ondrop"in document.createElement("div"))||typeof Promise>"u")}catch{return!1}}function w(e,t){let n=e.lastIndexOf(".");if(n>0){let c=e.slice(0,n),o=e.slice(n);return`${c}_${t}${o}`}throw new Error("Input filename must have an extension")}function h(e){return e.endsWith(`
`)?e:e.replace(/(?:\n?\r?)?$/,"")+`
`}y()||(document.body.innerHTML='<div style="padding:32px;max-width:600px;margin:40px auto;background:#111626;color:#e6e6e6;border-radius:14px;text-align:center;font-size:18px;">\u26A0\uFE0F Your browser is not supported.<br>Please update to the latest version of Chrome, Edge, Firefox, or Safari.</div>');var{default:E}=await import("https://cdn.jsdelivr.net/npm/7z-wasm@1.2.0/+esm"),i=await E(),g=document.getElementById("log");function d(e){g.textContent+=`
`+e,g.scrollTop=g.scrollHeight}var v=document.getElementById("engineStatus");v.textContent="Engine: ready (7z-wasm)";v.style.background="#1e3a1e";async function b(e,t,n={}){let{maxDelay:c=2e3}=n,o=URL.createObjectURL(e),a=document.createElement("a");a.style.display="none",a.href=o,a.download=t,document.body.appendChild(a);let u=!1,s=()=>{if(!u){u=!0;try{URL.revokeObjectURL(o)}catch{}try{a.remove()}catch{}document.removeEventListener("visibilitychange",l,!0),window.removeEventListener("pagehide",r,!0),window.removeEventListener("blur",p,!0)}},l=()=>{document.visibilityState==="hidden"&&s()},r=()=>s(),p=()=>{s()};return document.addEventListener("visibilitychange",l,!0),window.addEventListener("pagehide",r,!0),window.addEventListener("blur",p,!0),a.click(),new Promise(m=>{requestAnimationFrame(()=>{requestAnimationFrame(()=>{setTimeout(()=>{s(),m()},100)})}),setTimeout(()=>{s(),m()},c)})}async function x(e){d(`Processing: ${e.name} (${e.size} bytes)`);try{try{i.FS.unlink("/in.epk")}catch{}try{i.FS.rmdir("/out")}catch{}let t=new Uint8Array(await e.arrayBuffer());i.FS.writeFile("/in.epk",t);let n=["x","/in.epk","-o/out","-y"];await i.callMain(n);let c=i.FS.readdir("/out").filter(r=>r!=="."&&r!==".."),o=c.find(r=>r.toLowerCase()==="cert.txt");if(!o){d("\u26A0\uFE0F cert.txt not found. Returning original archive unchanged.");return}let a=i.FS.readFile(`/out/${o}`),u=new TextDecoder("utf-8").decode(a),s=h(u),l=s!==u;if(l){i.FS.writeFile(`/out/${o}`,new TextEncoder().encode(s)),d("Updated cert.txt: ensured trailing newline.");try{i.FS.unlink("/fixed.epk")}catch{}let r=["a","/fixed.epk"];for(let m of c)r.push(`/out/${m}`);await i.callMain(r);let p=i.FS.readFile("/fixed.epk");await b(new Blob([p],{type:"application/octet-stream"}),w(e.name,l?"fixed":"unchanged")),d("\u2705 Done. Download should start automatically.")}else d("\u2705 No change needed: cert.txt already ends with a newline.")}catch(t){d("Error: "+(t?.message||t))}}var f=document.getElementById("drop"),L=document.getElementById("file");["dragenter","dragover"].forEach(e=>f.addEventListener(e,t=>{t.preventDefault(),f.classList.add("drag")}));["dragleave","drop"].forEach(e=>f.addEventListener(e,t=>{t.preventDefault(),f.classList.remove("drag")}));f.addEventListener("drop",e=>{let t=e.dataTransfer&&e.dataTransfer.files&&e.dataTransfer.files[0];t&&x(t).catch(n=>d("Error: "+n.message))});L.addEventListener("change",e=>{let t=e.target.files&&e.target.files[0];t&&x(t).catch(n=>d("Error: "+n.message))});window.__PLAYWRIGHT_TEST__||import("https://esm.run/@sentry/browser").then(e=>{e.init({dsn:"https://34687dbd224e062d40708543ab4ff67a@o106156.ingest.us.sentry.io/4509853489364992"})});
</script>
  </body>
</html>
