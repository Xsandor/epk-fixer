<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>EPK fixer for 7z</title>
    <style>:root{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica Neue,Arial,Noto Sans}body{margin:0;padding:28px;background:#0b0e14;color:#e6e6e6}h1{font-size:20px;margin:0 0 10px}h2{font-size:18px;margin:0 0 10px}a{color:#a7b1c2;text-decoration:none}a:hover{text-decoration:underline}.app{max-width:860px;margin:0 auto;display:grid;gap:16px}.card{background:#111626;border:1px solid #1c2440;border-radius:14px;padding:16px;box-shadow:0 6px 18px #00000040}.row{display:grid;gap:16px}.drop{border:2px dashed #29407f;border-radius:14px;padding:26px;background:#0f1424;text-align:center}.drop.drag{background:#12204a}.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#1f2848;border:1px solid #33407a;font-size:12px}.muted{color:#a7b1c2;font-size:13px}.log{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;white-space:pre-wrap;background:#0f1424;padding:12px;border-radius:10px;border:1px solid #253157;max-height:240px;overflow:auto}input[type=file]{display:none}.btn{display:inline-flex;align-items:center;gap:8px;background:#2344ff;border:1px solid #2344ff;color:#fff;border-radius:10px;margin-top:5px;padding:10px 12px;cursor:pointer}
</style>
  </head>
  <body>
    <div class="app">
      <div class="card">
        <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px; flex-wrap: wrap;">
          <h1>üõ†Ô∏è EPK fixer</h1>
          <span class="badge" id="engineStatus">Engine: not loaded</span>
        </div>
        <p class="muted">
          Drop an <code>.epk</code> anywhere below. We'll ensure <code>cert.txt</code> ends with a newline, then instantly download the fixed .epk file. All processing happens locally in your browser.
        </p>
        <div id="drop" class="drop">
          <strong>Drop .epk here</strong>
          <br /><span class="muted">or</span><br />
          <label class="btn" for="file">Choose file</label>
          <input id="file" type="file" accept=".epk" />
        </div>
      </div>
      <div class="card">
        <h2>Log</h2>
        <div id="log" class="log">Ready.</div>
      </div>
      <footer style="max-width: 860px; margin: 24px auto 0 auto; text-align: center; color: #a7b1c2; font-size: 13px;">
        &copy; 2025 <a href="mailto:alex@karlborgs.com">Alexander Schmidt</a>. This tool is provided as-is, without warranty of any kind. Use at your own risk.
      </footer>
    </div>
    <script type="module">(()=>{var L=Object.create;var y=Object.defineProperty;var F=Object.getOwnPropertyDescriptor;var k=Object.getOwnPropertyNames;var S=Object.getPrototypeOf,$=Object.prototype.hasOwnProperty;var B=(o,n,c,i)=>{if(n&&typeof n=="object"||typeof n=="function")for(let d of k(n))!$.call(o,d)&&d!==c&&y(o,d,{get:()=>n[d],enumerable:!(i=F(n,d))||i.enumerable});return o};var T=(o,n,c)=>(c=o!=null?L(S(o)):{},B(n||!o||!o.__esModule?y(c,"default",{value:o,enumerable:!0}):c,o));function U(){try{return!(!("noModule"in document.createElement("script"))||typeof TextEncoder>"u"||typeof TextDecoder>"u"||typeof Uint8Array>"u"||typeof ArrayBuffer>"u"||typeof Blob>"u"||typeof URL>"u"||typeof URL.createObjectURL!="function"||typeof File>"u"||!("ondrop"in document.createElement("div"))||typeof Promise>"u")}catch{return!1}}U()||(document.body.innerHTML='<div style="padding:32px;max-width:600px;margin:40px auto;background:#111626;color:#e6e6e6;border-radius:14px;text-align:center;font-size:18px;">\u26A0\uFE0F Your browser is not supported.<br>Please update to the latest version of Chrome, Edge, Firefox, or Safari.</div>');async function C(){const o=(await import("https://cdn.jsdelivr.net/npm/7z-wasm@1.2.0/+esm")).default,n=await o(),c=document.getElementById("log");function i(e){c.textContent+=`
`+e,c.scrollTop=c.scrollHeight}const d=document.getElementById("engineStatus");d.textContent="Engine: ready (7z-wasm)",d.style.background="#1e3a1e";function D(e){const t=e.map(r=>[r,r.toLowerCase()]);for(const[r,a]of t)if(a.split("/").pop().split("\\").pop()==="cert.txt")return r;return null}function h(e,t){const r=e.lastIndexOf(".");if(r>0){const a=e.slice(0,r),f=e.slice(r);return`${a}_${t}${f}`}return`${e}_${t}.7z`}function x(e,t){const r=URL.createObjectURL(e),a=document.createElement("a");a.href=r,a.download=t,document.body.appendChild(a),a.click(),a.remove(),URL.revokeObjectURL(r)}async function p(e){i(`Processing: ${e.name} (${e.size} bytes)`);try{try{n.FS.unlink("/in.epk")}catch{}try{n.FS.rmdir("/out")}catch{}const t=new Uint8Array(await e.arrayBuffer());n.FS.writeFile("/in.epk",t);const r=["x","/in.epk","-o/out","-y"];await n.callMain(r);const a=n.FS.readdir("/out").filter(s=>s!=="."&&s!==".."),f=a.find(s=>s.toLowerCase()==="cert.txt");if(!f){i("\u26A0\uFE0F cert.txt not found. Returning original archive unchanged.");return}const E=n.FS.readFile(`/out/${f}`),u=new TextDecoder("utf-8").decode(E);let g=u.endsWith(`
`)?u:u.replace(/(?:\n?\r?)?$/,"")+`
`;const m=g!==u;if(m){n.FS.writeFile(`/out/${f}`,new TextEncoder().encode(g)),i("Updated cert.txt: ensured trailing newline.");try{n.FS.unlink("/fixed.epk")}catch{}const s=["a","/fixed.epk"];for(const b of a)s.push(`/out/${b}`);await n.callMain(s);const v=n.FS.readFile("/fixed.epk");x(new Blob([v],{type:"application/octet-stream"}),h(e.name,m?"fixed":"unchanged")),i("\u2705 Done. Download should start automatically.")}else i("\u2705 No change needed: cert.txt already ends with a newline.")}catch(t){i("Error: "+(t?.message||t))}}const l=document.getElementById("drop"),w=document.getElementById("file");["dragenter","dragover"].forEach(e=>l.addEventListener(e,t=>{t.preventDefault(),l.classList.add("drag")})),["dragleave","drop"].forEach(e=>l.addEventListener(e,t=>{t.preventDefault(),l.classList.remove("drag")})),l.addEventListener("drop",e=>{const t=e.dataTransfer&&e.dataTransfer.files&&e.dataTransfer.files[0];t&&p(t).catch(r=>i("Error: "+r.message))}),w.addEventListener("change",e=>{const t=e.target.files&&e.target.files[0];t&&p(t).catch(r=>i("Error: "+r.message))})}C();})();
</script>
  </body>
</html>
