<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EPK fixer</title>
    <style>:root{--ui-scale: 1;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica Neue,Arial,Noto Sans}html{font-size:calc(100% * var(--ui-scale))}body{margin:0;padding:25px;background:#0b0e14;color:#e6e6e6;line-height:1.5;font-size:1rem}p{margin-top:.3125rem}h1{font-size:1.25rem;margin:0 0 .625rem}h2{font-size:1.125rem;margin:0 0 .625rem}a{color:#a7b1c2;text-decoration:none}a:hover{text-decoration:underline}.app{max-width:54rem;margin:0 auto;display:grid;gap:1rem}header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}footer{max-width:54rem;margin:1.5rem auto 0;text-align:center;color:#a7b1c2;font-size:.8125rem}.card{background:#111626;border:1px solid #1c2440;border-radius:.875rem;padding:1rem;box-shadow:0 .375rem 1.125rem #00000040}.row{display:grid;gap:16px}.drop{border:.125rem dashed #29407f;border-radius:.875rem;padding:1.625rem;background:#0f1424;text-align:center}.drop.drag{background:#12204a}.badge{display:inline-block;padding:.125rem .5rem;border-radius:999px;background:#1f2848;border:1px solid #33407a;font-size:.75rem;margin-bottom:.625rem}.muted{color:#a7b1c2;font-size:.875rem}.log{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:.75rem;white-space:pre-wrap;background:#0f1424;padding:.75rem;border-radius:.625rem;border:1px solid #253157;max-height:15rem;overflow:auto}input[type=file]{display:none}.btn{display:inline-flex;align-items:center;gap:.5rem;background:#2344ff;border:1px solid #2344ff;color:#fff;border-radius:.625rem;margin-top:.3125rem;padding:.5em 1em;cursor:pointer}@media (max-width: 600px){:root{--ui-scale: 1.0625}body{margin:0;padding:10px}}
</style>
  </head>
  <body>
    <div class="app">
      <div class="card">
        <header>
          <h1>üõ†Ô∏è EPK fixer</h1>
          <span class="badge" id="engineStatus">Engine: not loaded</span>
        </header>
        <p class="muted">
          Drop one or more <code>.epk</code> files below. We'll ensure compatibility with AK-SM 800A v4.3.1, then instantly download the fixed .epk file.
        </p>
        <p class="muted">
          All processing happens locally in your browser.
        </p>
        <div id="drop" class="drop">
          <strong>Drop .epk here</strong>
          <br /><span class="muted">or</span><br />
          <label class="btn" for="file">Choose file</label>
          <input id="file" type="file" accept=".epk" multiple />
          <div id="drop-hint" class="muted" style="margin-top:12px;">Tip: Upload one <code>.epk</code> to fix it, or select multiple <code>.epk</code> files to combine them into a single fixed package.</div>
        </div>
      </div>
      <div class="card">
        <h2>Log</h2>
        <div id="log" class="log">Ready.</div>
      </div>
      <footer>
        &copy; 2025 <a href="mailto:alex@karlborgs.com">Alexander Schmidt</a>. This tool is provided as-is, without warranty of any kind. Use at your own risk.
      </footer>
    </div>
    <script type="module">function U(){try{return!(!("noModule"in document.createElement("script"))||typeof TextEncoder>"u"||typeof TextDecoder>"u"||typeof Uint8Array>"u"||typeof ArrayBuffer>"u"||typeof Blob>"u"||typeof URL>"u"||typeof URL.createObjectURL!="function"||typeof File>"u"||!("ondrop"in document.createElement("div"))||typeof Promise>"u")}catch{return!1}}function A(n,t){let r=n.lastIndexOf(".");if(r>0){let i=n.slice(0,r),s=n.slice(r);return`${i}_${t}${s}`}throw new Error("Input filename must have an extension")}function B(n){return n.endsWith(`
`)?n:n.replace(/(?:\n?\r?)?$/,"")+`
`}function k(n=Date.now(),t="epks"){let r=new Date(n),i=h=>String(h).padStart(2,"0"),s=r.getUTCFullYear(),c=i(r.getUTCMonth()+1),f=i(r.getUTCDate()),o=i(r.getUTCHours()),y=i(r.getUTCMinutes()),l=i(r.getUTCSeconds());return`${t}_${s}-${c}-${f}_${o}-${y}-${l}.zip`}async function x(n,{fixOne:t,combineMulti:r,autoDownload:i,singleOutNamer:s}){let c=Array.from(n||[]);if(c.length!==0){if(c.length===1){let f=c[0],o=await t(f);o&&o.blob&&o.name&&o.changed&&await i(o.blob,o.name);return}if(typeof r=="function"){await r(n);return}}}U()||(document.body.innerHTML='<div style="padding:32px;max-width:600px;margin:40px auto;background:#111626;color:#e6e6e6;border-radius:14px;text-align:center;font-size:18px;">\u26A0\uFE0F Your browser is not supported.<br>Please update to the latest version of Chrome, Edge, Firefox, or Safari.</div>');var{default:O}=await import("https://cdn.jsdelivr.net/npm/7z-wasm@1.2.0/+esm"),e=await O({print:()=>{}}),E=document.getElementById("log");function u(n){E.textContent+=`
`+n,E.scrollTop=E.scrollHeight}var M=document.getElementById("engineStatus");M.textContent="Engine: ready (7z-wasm)";M.style.background="#1e3a1e";async function _(n,t,r={}){let{maxDelay:i=2e3}=r,s=URL.createObjectURL(n),c=document.createElement("a");c.style.display="none",c.href=s,c.download=t,document.body.appendChild(c);let f=!1,o=()=>{if(!f){f=!0;try{URL.revokeObjectURL(s)}catch{}try{c.remove()}catch{}document.removeEventListener("visibilitychange",y,!0),window.removeEventListener("pagehide",l,!0),window.removeEventListener("blur",h,!0)}},y=()=>{document.visibilityState==="hidden"&&o()},l=()=>o(),h=()=>{o()};return document.addEventListener("visibilitychange",y,!0),window.addEventListener("pagehide",l,!0),window.addEventListener("blur",h,!0),c.click(),new Promise(g=>{requestAnimationFrame(()=>{requestAnimationFrame(()=>{setTimeout(()=>{o(),g()},100)})}),setTimeout(()=>{o(),g()},i)})}async function C(n){u(`Processing: ${n.name} (${n.size} bytes)`);try{try{e.FS.unlink("/in.epk")}catch{}try{e.FS.rmdir("/out")}catch{}let t=new Uint8Array(await n.arrayBuffer());e.FS.writeFile("/in.epk",t);let r=["x","/in.epk","-o/out","-y","-bb0"];await e.callMain(r);let i=e.FS.readdir("/out").filter(l=>l!=="."&&l!==".."),s=i.find(l=>l.toLowerCase()==="cert.txt");if(!s)return u("\u26A0\uFE0F cert.txt not found. Returning original archive unchanged."),{name:n.name,blob:null,changed:!1};let c=e.FS.readFile(`/out/${s}`),f=new TextDecoder("utf-8").decode(c),o=B(f);if(o!==f){e.FS.writeFile(`/out/${s}`,new TextEncoder().encode(o)),u("Updated cert.txt: ensured trailing newline.");try{e.FS.unlink("/fixed.epk")}catch{}let l=["a","/fixed.epk","-bb0"];for(let S of i)l.push(`/out/${S}`);await e.callMain(l);let h=e.FS.readFile("/fixed.epk"),g=new Blob([h],{type:"application/octet-stream"});u("\u2705 Done. Ready for download.");try{let S=e.FS.readdir("/out").filter(a=>a!=="."&&a!=="..");for(let a of S)try{e.FS.unlink(`/out/${a}`)}catch{}try{e.FS.rmdir("/out")}catch{}}catch{}try{e.FS.unlink("/fixed.epk")}catch{}try{e.FS.unlink("/in.epk")}catch{}return{name:A(n.name,"fixed"),blob:g,changed:!0}}else return u("\u2705 No change needed: cert.txt already ends with a newline."),{name:n.name,blob:null,changed:!1}}catch(t){return u("Error: "+(t?.message||t)),{name:n.name,blob:null,changed:!1}}}async function P(n){let t=new Uint8Array(n);return Array.from(t).map(r=>r.toString(16).padStart(2,"0")).join("")}async function v(n){u(`Combining ${n.length} .epk files into one package`);let t="/combine";try{e.FS.rmdir(t)}catch{}try{e.FS.mkdir(t)}catch{}let r=`${t}/inner`;try{e.FS.rmdir(r)}catch{}try{e.FS.mkdir(r)}catch{}let i=0;for(let a of Array.from(n)){i++;let d=`${t}/in${i}.epk`;try{e.FS.unlink(d)}catch{}let F=new Uint8Array(await a.arrayBuffer());e.FS.writeFile(d,F),await e.callMain(["x",d,`-o${t}/out${i}`,"-y","-bb0"]);let T=e.FS.readdir(`${t}/out${i}`).filter(m=>m!=="."&&m!=="..").find(m=>m==="SM800A_Upgrade_Source.7z");if(!T){u(`\u26A0\uFE0F File ${a.name} missing SM800A_Upgrade_Source.7z \u2014 skipping`);continue}let N=e.FS.readFile(`${t}/out${i}/${T}`),w=`${t}/inner_${i}.7z`;try{e.FS.unlink(w)}catch{}e.FS.writeFile(w,N);let b=`${t}/inner_out${i}`;try{e.FS.rmdir(b)}catch{}try{e.FS.mkdir(b)}catch{}await e.callMain(["x",w,`-o${b}`,"-y","-bb0"]);let D=e.FS.readdir(b).filter(m=>m!=="."&&m!=="..");for(let m of D){let z=e.FS.readFile(`${b}/${m}`),L=m;e.FS.readdir(r).includes(m)&&(L=`${i}_${m}`),e.FS.writeFile(`${r}/${L}`,z)}}let s=`${t}/SM800A_Upgrade_Source.7z`;try{e.FS.unlink(s)}catch{}let c=e.FS.readdir(r).filter(a=>a!=="."&&a!=="..");if(c.length===0){u("No inner files collected \u2014 aborting combine.");return}let f=["a",s];for(let a of c)f.push(`${r}/${a}`);await e.callMain(f.concat(["-bb0"]));let o=e.FS.readFile(s),y=await crypto.subtle.digest("SHA-256",o),h=`${await P(y)} SM800A_Upgrade_Source.7z
`;e.FS.writeFile(`${t}/cert.txt`,new TextEncoder().encode(h));try{e.FS.unlink("/combined.epk")}catch{}e.FS.writeFile(`${t}/SM800A_Upgrade_Source.7z`,o),await e.callMain(["a","/combined.epk",`${t}/SM800A_Upgrade_Source.7z`,`${t}/cert.txt`,"-y","-bb0"]);let g=e.FS.readFile("/combined.epk"),S=`EPK_Package_${new Date().toISOString().replace(/[:.]/g,"-").replace(/T/,"_").slice(0,19)}.epk`;await _(new Blob([g],{type:"application/octet-stream"}),S),u("\u2705 Combined EPK ready for download: "+S);try{let a=e.FS.readdir(r).filter(d=>d!=="."&&d!=="..");for(let d of a)try{e.FS.unlink(`${r}/${d}`)}catch{}try{e.FS.rmdir(r)}catch{}}catch{}for(let a=1;a<=n.length;a++){try{let d=`${t}/out${a}`,F=e.FS.readdir(d).filter(p=>p!=="."&&p!=="..");for(let p of F)try{e.FS.unlink(`${d}/${p}`)}catch{}try{e.FS.rmdir(d)}catch{}}catch{}try{e.FS.unlink(`${t}/inner_${a}.7z`)}catch{}try{let d=`${t}/inner_out${a}`,F=e.FS.readdir(d).filter(p=>p!=="."&&p!=="..");for(let p of F)try{e.FS.unlink(`${d}/${p}`)}catch{}try{e.FS.rmdir(d)}catch{}}catch{}try{e.FS.unlink(`${t}/in${a}.epk`)}catch{}}try{e.FS.unlink(s)}catch{}try{e.FS.unlink(`${t}/SM800A_Upgrade_Source.7z`)}catch{}try{e.FS.unlink(`${t}/cert.txt`)}catch{}try{e.FS.unlink("/combined.epk")}catch{}try{e.FS.rmdir(t)}catch{}}var $=document.getElementById("drop"),R=document.getElementById("file");["dragenter","dragover"].forEach(n=>$.addEventListener(n,t=>{t.preventDefault(),$.classList.add("drag")}));["dragleave","drop"].forEach(n=>$.addEventListener(n,t=>{t.preventDefault(),$.classList.remove("drag")}));$.addEventListener("drop",n=>{let t=n.dataTransfer&&n.dataTransfer.files?n.dataTransfer.files:null;t&&x(t,{fixOne:C,combineMulti:v,autoDownload:_,singleOutNamer:()=>k()}).catch(r=>u("Error: "+r.message))});R.addEventListener("change",n=>{let t=n.target.files;t&&(t.length>1?v(t).catch(r=>u("Error: "+(r?.message||r))):x(t,{fixOne:C,combineMulti:v,autoDownload:_,singleOutNamer:()=>k()}).catch(r=>u("Error: "+r.message)))});window.__PLAYWRIGHT_TEST__||import("https://esm.run/@sentry/browser").then(n=>{n.init({dsn:"https://34687dbd224e062d40708543ab4ff67a@o106156.ingest.us.sentry.io/4509853489364992"})});
</script>
  </body>
</html>
