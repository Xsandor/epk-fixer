<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#111626" />
    <link rel="icon" type="image/png" href="icons/icon-192.png" />
    <link rel="apple-touch-icon" href="icons/icon-192.png" />
    <title>EPK fixer</title>
    <style>:root{--ui-scale: 1;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica Neue,Arial,Noto Sans}html{font-size:calc(100% * var(--ui-scale))}body{margin:0;padding:25px;background:#0b0e14;color:#e6e6e6;line-height:1.5;font-size:1rem}p{margin-top:.3125rem}h1{font-size:1.25rem;margin:0 0 .625rem}h2{font-size:1.125rem;margin:0 0 .625rem}a{color:#a7b1c2;text-decoration:none}a:hover{text-decoration:underline}.app{max-width:54rem;margin:0 auto;display:grid;gap:1rem}header{display:flex;flex-wrap:wrap}header h1{flex:1;margin-left:5px}footer{max-width:54rem;color:#a7b1c2;font-size:.8125rem;display:flex;flex-wrap:wrap;gap:.5rem .75rem;align-items:baseline;justify-content:center;text-align:center}footer .copyright{white-space:nowrap}@media (max-width: 520px){footer .disclaimer{flex-basis:100%}}.card{background:#111626;border:1px solid #1c2440;border-radius:.875rem;padding:1rem;box-shadow:0 .375rem 1.125rem #00000040}.row{display:grid;gap:16px}.drop{border:.125rem dashed #29407f;border-radius:.875rem;padding:1.625rem;background:#0f1424;text-align:center}.drop.drag{background:#12204a}.badge{display:flex;justify-content:center;padding:.2rem .6rem;border-radius:999px;background:#1f2848;border:1px solid #33407a;font-size:.75rem;margin-bottom:.625rem}.muted{color:#a7b1c2;font-size:.875rem}.log{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:.75rem;white-space:pre-wrap;background:#0f1424;padding:.75rem;border-radius:.625rem;border:1px solid #253157;max-height:15rem;overflow:auto}input[type=file]{display:none}.btn{display:inline-flex;align-items:center;gap:.5rem;background:#2344ff;border:1px solid #2344ff;color:#fff;border-radius:.625rem;margin-top:.3125rem;padding:.5em 1em;cursor:pointer}@media (max-width: 600px){:root{--ui-scale: 1.0625}body{margin:0;padding:10px}}
</style>
    <script
      defer
      src="https://cloud.umami.is/script.js"
      data-website-id="ba8ead4f-31db-45e1-bbcc-d1c7deb88b2f"
      data-domains="xsandor.github.io"
    ></script>
  </head>
  <body>
    <div class="app">
      <div class="card">
        <header>
          <img src="icons/icon-32.png" height="32" />
          <h1>EPK fixer</h1>
          <span class="badge" id="engineStatus">Engine: not loaded</span>
        </header>
        <p class="muted">
          Drop one or more <code>.epk</code> files below. We'll ensure
          compatibility with AK-SM 800A v4.3.1, then instantly download the
          fixed .epk file.
        </p>
        <p class="muted">All processing happens locally in your browser.</p>
        <div id="drop" class="drop">
          <strong>Drop .epk here</strong>
          <br /><span class="muted">or</span><br />
          <label class="btn" for="file">Choose file</label>
          <input id="file" type="file" accept=".epk" multiple />
          <div id="drop-hint" class="muted" style="margin-top: 12px">
            Tip: Upload one <code>.epk</code> to fix it, or select multiple
            <code>.epk</code> files to combine them into a single fixed package.
          </div>
        </div>
      </div>
      <div class="card">
        <h2>Log</h2>
        <div id="log" class="log">Ready.</div>
      </div>
      <footer>
        <span class="copyright">Â© 2025 Alexander Schmidt.</span>
        <span class="disclaimer"
          >This tool is provided as-is, without warranty of any kind. Use at
          your own risk.</span
        >
      </footer>
    </div>
    <script type="module">function E(){try{return!(!("noModule"in document.createElement("script"))||typeof TextEncoder>"u"||typeof TextDecoder>"u"||typeof Uint8Array>"u"||typeof ArrayBuffer>"u"||typeof Blob>"u"||typeof URL>"u"||typeof URL.createObjectURL!="function"||typeof File>"u"||!("ondrop"in document.createElement("div"))||typeof Promise>"u")}catch{return!1}}function _(t,n){let r=t.lastIndexOf(".");if(r>0){let o=t.slice(0,r),a=t.slice(r);return`${o}_${n}${a}`}throw new Error("Input filename must have an extension")}function L(t){return t.endsWith(`
`)?t:t.replace(/(?:\n?\r?)?$/,"")+`
`}async function T(t,{fixOne:n,combineMulti:r,autoDownload:o}){let a=Array.from(t||[]);if(a.length!==0){if(a.length===1){let d=a[0],s=await n(d);s&&s.blob&&s.name&&s.changed&&(await o(s.blob,s.name),window.umami.track("fix-single-epk"));return}if(typeof r=="function"){await r(t),window.umami.track("fix-multiple-epk",{fileCount:t.length});return}}}E()||(document.body.innerHTML='<div style="padding:32px;max-width:600px;margin:40px auto;background:#111626;color:#e6e6e6;border-radius:14px;text-align:center;font-size:18px;">\u26A0\uFE0F Your browser is not supported.<br>Please update to the latest version of Chrome, Edge, Firefox, or Safari.</div>');var z="EPK Fixer";function N(){return window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone===!0}function U(){N()?document.title="":document.title=z}var R=window.matchMedia("(display-mode: standalone)");R.addEventListener?.("change",()=>U());U();var{default:O}=await import("https://cdn.jsdelivr.net/npm/7z-wasm@1.2.0/+esm"),e=await O({print:()=>{}}),k=document.getElementById("log");function p(t){k.textContent+=`
`+t,k.scrollTop=k.scrollHeight}var A=document.getElementById("engineStatus");A.textContent="Engine: ready (7z-wasm)";A.style.background="#1e3a1e";async function B(t,n,r={}){let{maxDelay:o=2e3}=r,a=URL.createObjectURL(t),d=document.createElement("a");d.style.display="none",d.href=a,d.download=n,document.body.appendChild(d);let s=!1,u=()=>{if(!s){s=!0;try{URL.revokeObjectURL(a)}catch{}try{d.remove()}catch{}document.removeEventListener("visibilitychange",S,!0),window.removeEventListener("pagehide",f,!0),window.removeEventListener("blur",h,!0)}},S=()=>{document.visibilityState==="hidden"&&u()},f=()=>u(),h=()=>{u()};return document.addEventListener("visibilitychange",S,!0),window.addEventListener("pagehide",f,!0),window.addEventListener("blur",h,!0),d.click(),new Promise(g=>{requestAnimationFrame(()=>{requestAnimationFrame(()=>{setTimeout(()=>{u(),g()},100)})}),setTimeout(()=>{u(),g()},o)})}async function H(t){p(`Processing: ${t.name} (${t.size} bytes)`);try{try{e.FS.unlink("/in.epk")}catch{}try{e.FS.rmdir("/out")}catch{}let n=new Uint8Array(await t.arrayBuffer());e.FS.writeFile("/in.epk",n);let r=["x","/in.epk","-o/out","-y","-bb0"];await e.callMain(r);let o=e.FS.readdir("/out").filter(f=>f!=="."&&f!==".."),a=o.find(f=>f.toLowerCase()==="cert.txt");if(!a)return p("\u26A0\uFE0F cert.txt not found. Returning original archive unchanged."),{name:t.name,blob:null,changed:!1};let d=e.FS.readFile(`/out/${a}`),s=new TextDecoder("utf-8").decode(d),u=L(s);if(u!==s){e.FS.writeFile(`/out/${a}`,new TextEncoder().encode(u)),p("Updated cert.txt: ensured trailing newline.");try{e.FS.unlink("/fixed.epk")}catch{}let f=["a","/fixed.epk","-bb0"];for(let y of o)f.push(`/out/${y}`);await e.callMain(f);let h=e.FS.readFile("/fixed.epk"),g=new Blob([h],{type:"application/octet-stream"});p("\u2705 Done. Ready for download.");try{let y=e.FS.readdir("/out").filter(i=>i!=="."&&i!=="..");for(let i of y)try{e.FS.unlink(`/out/${i}`)}catch{}try{e.FS.rmdir("/out")}catch{}}catch{}try{e.FS.unlink("/fixed.epk")}catch{}try{e.FS.unlink("/in.epk")}catch{}return{name:_(t.name,"fixed"),blob:g,changed:!0}}else return p("\u2705 No change needed: cert.txt already ends with a newline."),{name:t.name,blob:null,changed:!1}}catch(n){return p("Error: "+(n?.message||n)),{name:t.name,blob:null,changed:!1}}}async function I(t){let n=new Uint8Array(t);return Array.from(n).map(r=>r.toString(16).padStart(2,"0")).join("")}async function W(t){p(`Combining ${t.length} .epk files into one package`);let n="/combine";try{e.FS.rmdir(n)}catch{}try{e.FS.mkdir(n)}catch{}let r=`${n}/inner`;try{e.FS.rmdir(r)}catch{}try{e.FS.mkdir(r)}catch{}let o=0;for(let i of Array.from(t)){o++;let c=`${n}/in${o}.epk`;try{e.FS.unlink(c)}catch{}let F=new Uint8Array(await i.arrayBuffer());e.FS.writeFile(c,F),await e.callMain(["x",c,`-o${n}/out${o}`,"-y","-bb0"]);let x=e.FS.readdir(`${n}/out${o}`).filter(l=>l!=="."&&l!=="..").find(l=>l==="SM800A_Upgrade_Source.7z");if(!x){p(`\u26A0\uFE0F File ${i.name} missing SM800A_Upgrade_Source.7z \u2014 skipping`);continue}let C=e.FS.readFile(`${n}/out${o}/${x}`),$=`${n}/inner_${o}.7z`;try{e.FS.unlink($)}catch{}e.FS.writeFile($,C);let w=`${n}/inner_out${o}`;try{e.FS.rmdir(w)}catch{}try{e.FS.mkdir(w)}catch{}await e.callMain(["x",$,`-o${w}`,"-y","-bb0"]);let D=e.FS.readdir(w).filter(l=>l!=="."&&l!=="..");for(let l of D){let P=e.FS.readFile(`${w}/${l}`),v=l;e.FS.readdir(r).includes(l)&&(v=`${o}_${l}`),e.FS.writeFile(`${r}/${v}`,P)}}let a=`${n}/SM800A_Upgrade_Source.7z`;try{e.FS.unlink(a)}catch{}let d=e.FS.readdir(r).filter(i=>i!=="."&&i!=="..");if(d.length===0){p("No inner files collected \u2014 aborting combine.");return}let s=["a",a];for(let i of d)s.push(`${r}/${i}`);await e.callMain(s.concat(["-bb0"]));let u=e.FS.readFile(a),S=await crypto.subtle.digest("SHA-256",u),h=`${await I(S)} SM800A_Upgrade_Source.7z
`;e.FS.writeFile(`${n}/cert.txt`,new TextEncoder().encode(h));try{e.FS.unlink("/combined.epk")}catch{}e.FS.writeFile(`${n}/SM800A_Upgrade_Source.7z`,u),await e.callMain(["a","/combined.epk",`${n}/SM800A_Upgrade_Source.7z`,`${n}/cert.txt`,"-y","-bb0"]);let g=e.FS.readFile("/combined.epk"),y=`EPK_Package_${new Date().toISOString().replace(/[:.]/g,"-").replace(/T/,"_").slice(0,19)}.epk`;await B(new Blob([g],{type:"application/octet-stream"}),y),p("\u2705 Combined EPK ready for download: "+y);try{let i=e.FS.readdir(r).filter(c=>c!=="."&&c!=="..");for(let c of i)try{e.FS.unlink(`${r}/${c}`)}catch{}try{e.FS.rmdir(r)}catch{}}catch{}for(let i=1;i<=t.length;i++){try{let c=`${n}/out${i}`,F=e.FS.readdir(c).filter(m=>m!=="."&&m!=="..");for(let m of F)try{e.FS.unlink(`${c}/${m}`)}catch{}try{e.FS.rmdir(c)}catch{}}catch{}try{e.FS.unlink(`${n}/inner_${i}.7z`)}catch{}try{let c=`${n}/inner_out${i}`,F=e.FS.readdir(c).filter(m=>m!=="."&&m!=="..");for(let m of F)try{e.FS.unlink(`${c}/${m}`)}catch{}try{e.FS.rmdir(c)}catch{}}catch{}try{e.FS.unlink(`${n}/in${i}.epk`)}catch{}}try{e.FS.unlink(a)}catch{}try{e.FS.unlink(`${n}/SM800A_Upgrade_Source.7z`)}catch{}try{e.FS.unlink(`${n}/cert.txt`)}catch{}try{e.FS.unlink("/combined.epk")}catch{}try{e.FS.rmdir(n)}catch{}}var b=document.getElementById("drop"),j=document.getElementById("file");["dragenter","dragover"].forEach(t=>b.addEventListener(t,n=>{n.preventDefault(),b.classList.add("drag")}));["dragleave","drop"].forEach(t=>b.addEventListener(t,n=>{n.preventDefault(),b.classList.remove("drag")}));var Z=()=>({fixOne:H,combineMulti:W,autoDownload:B});function M(t){t&&T(t,Z()).catch(n=>p("Error: "+(n?.message||n)))}b.addEventListener("drop",t=>{t.preventDefault();let n=t?.dataTransfer?.files??null;M(n)});j.addEventListener("change",t=>{let n=t?.target?.files??null;M(n)});window.__PLAYWRIGHT_TEST__||import("https://esm.run/@sentry/browser").then(t=>{t.init({dsn:"https://34687dbd224e062d40708543ab4ff67a@o106156.ingest.us.sentry.io/4509853489364992"})});"serviceWorker"in navigator&&(location.protocol==="https:"||location.protocol==="http:")&&window.addEventListener("load",()=>{navigator.serviceWorker.register("./sw.js").then(t=>{console.log("ServiceWorker registered with scope:",t.scope)}).catch(t=>{console.warn("ServiceWorker registration failed:",t)})});
</script>
  </body>
</html>
