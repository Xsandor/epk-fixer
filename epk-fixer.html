<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#111626" />
    <link rel="icon" type="image/png" href="icons/icon-192.png" />
    <link rel="apple-touch-icon" href="icons/icon-192.png" />
    <title>EPK fixer</title>
    <style>:root{--ui-scale: 1;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica Neue,Arial,Noto Sans}html{font-size:calc(100% * var(--ui-scale))}body{margin:0;padding:25px;background:#0b0e14;color:#e6e6e6;line-height:1.5;font-size:1rem}p{margin-top:.3125rem}h1{font-size:1.25rem;margin:0 0 .625rem}h2{font-size:1.125rem;margin:0 0 .625rem}a{color:#a7b1c2;text-decoration:none}a:hover{text-decoration:underline}.app{max-width:54rem;margin:0 auto;display:grid;gap:1rem}header{display:flex;flex-wrap:wrap}header h1{flex:1;margin-left:5px}footer{max-width:54rem;color:#a7b1c2;font-size:.8125rem;display:flex;flex-wrap:wrap;gap:.5rem .75rem;align-items:baseline;justify-content:center;text-align:center}footer .copyright{white-space:nowrap}@media (max-width: 520px){footer .disclaimer{flex-basis:100%}}.card{background:#111626;border:1px solid #1c2440;border-radius:.875rem;padding:1rem;box-shadow:0 .375rem 1.125rem #00000040}.row{display:grid;gap:16px}.drop{border:.125rem dashed #29407f;border-radius:.875rem;padding:1.625rem;background:#0f1424;text-align:center}.drop.drag{background:#12204a}.badge{display:flex;justify-content:center;padding:.2rem .6rem;border-radius:999px;background:#1f2848;border:1px solid #33407a;font-size:.75rem;margin-bottom:.625rem}.muted{color:#a7b1c2;font-size:.875rem}.log{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:.75rem;white-space:pre-wrap;background:#0f1424;padding:.75rem;border-radius:.625rem;border:1px solid #253157;max-height:15rem;overflow:auto}input[type=file]{display:none}.btn{display:inline-flex;align-items:center;gap:.5rem;background:#2344ff;border:1px solid #2344ff;color:#fff;border-radius:.625rem;margin-top:.3125rem;padding:.5em 1em;cursor:pointer}@media (max-width: 600px){:root{--ui-scale: 1.0625}body{margin:0;padding:10px}}
</style>
    <script
      defer
      src="https://cloud.umami.is/script.js"
      data-website-id="ba8ead4f-31db-45e1-bbcc-d1c7deb88b2f"
    ></script>
  </head>
  <body>
    <div class="app">
      <div class="card">
        <header>
          <img src="icons/icon-32.png" height="32" />
          <h1>EPK fixer</h1>
          <span class="badge" id="engineStatus">Engine: not loaded</span>
        </header>
        <p class="muted">
          Drop one or more <code>.epk</code> files below. We'll ensure
          compatibility with AK-SM 800A v4.3.1, then instantly download the
          fixed .epk file.
        </p>
        <p class="muted">All processing happens locally in your browser.</p>
        <div id="drop" class="drop">
          <strong>Drop .epk here</strong>
          <br /><span class="muted">or</span><br />
          <label class="btn" for="file">Choose file</label>
          <input id="file" type="file" accept=".epk" multiple />
          <div id="drop-hint" class="muted" style="margin-top: 12px">
            Tip: Upload one <code>.epk</code> to fix it, or select multiple
            <code>.epk</code> files to combine them into a single fixed package.
          </div>
        </div>
      </div>
      <div class="card">
        <h2>Log</h2>
        <div id="log" class="log">Ready.</div>
      </div>
      <footer>
        <span class="copyright">Â© 2025 Alexander Schmidt.</span>
        <span class="disclaimer"
          >This tool is provided as-is, without warranty of any kind. Use at
          your own risk.</span
        >
      </footer>
    </div>
    <script type="module">function U(){try{return!(!("noModule"in document.createElement("script"))||typeof TextEncoder>"u"||typeof TextDecoder>"u"||typeof Uint8Array>"u"||typeof ArrayBuffer>"u"||typeof Blob>"u"||typeof URL>"u"||typeof URL.createObjectURL!="function"||typeof File>"u"||!("ondrop"in document.createElement("div"))||typeof Promise>"u")}catch{return!1}}function A(t,n){let r=t.lastIndexOf(".");if(r>0){let i=t.slice(0,r),s=t.slice(r);return`${i}_${n}${s}`}throw new Error("Input filename must have an extension")}function M(t){return t.endsWith(`
`)?t:t.replace(/(?:\n?\r?)?$/,"")+`
`}function k(t=Date.now(),n="epks"){let r=new Date(t),i=h=>String(h).padStart(2,"0"),s=r.getUTCFullYear(),c=i(r.getUTCMonth()+1),f=i(r.getUTCDate()),a=i(r.getUTCHours()),g=i(r.getUTCMinutes()),l=i(r.getUTCSeconds());return`${n}_${s}-${c}-${f}_${a}-${g}-${l}.zip`}async function x(t,{fixOne:n,combineMulti:r,autoDownload:i,singleOutNamer:s}){let c=Array.from(t||[]);if(c.length!==0){if(c.length===1){let f=c[0],a=await n(f);a&&a.blob&&a.name&&a.changed&&(await i(a.blob,a.name),window.umami.track("fix-single-epk"));return}if(typeof r=="function"){await r(t),window.umami.track("fix-multiple-epk",{fileCount:t.length});return}}}U()||(document.body.innerHTML='<div style="padding:32px;max-width:600px;margin:40px auto;background:#111626;color:#e6e6e6;border-radius:14px;text-align:center;font-size:18px;">\u26A0\uFE0F Your browser is not supported.<br>Please update to the latest version of Chrome, Edge, Firefox, or Safari.</div>');var O="EPK Fixer";function R(){return window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone===!0}function B(){R()?document.title="":document.title=O}var I=window.matchMedia("(display-mode: standalone)");I.addEventListener?.("change",()=>B());B();var{default:H}=await import("https://cdn.jsdelivr.net/npm/7z-wasm@1.2.0/+esm"),e=await H({print:()=>{}}),v=document.getElementById("log");function u(t){v.textContent+=`
`+t,v.scrollTop=v.scrollHeight}var C=document.getElementById("engineStatus");C.textContent="Engine: ready (7z-wasm)";C.style.background="#1e3a1e";async function _(t,n,r={}){let{maxDelay:i=2e3}=r,s=URL.createObjectURL(t),c=document.createElement("a");c.style.display="none",c.href=s,c.download=n,document.body.appendChild(c);let f=!1,a=()=>{if(!f){f=!0;try{URL.revokeObjectURL(s)}catch{}try{c.remove()}catch{}document.removeEventListener("visibilitychange",g,!0),window.removeEventListener("pagehide",l,!0),window.removeEventListener("blur",h,!0)}},g=()=>{document.visibilityState==="hidden"&&a()},l=()=>a(),h=()=>{a()};return document.addEventListener("visibilitychange",g,!0),window.addEventListener("pagehide",l,!0),window.addEventListener("blur",h,!0),c.click(),new Promise(y=>{requestAnimationFrame(()=>{requestAnimationFrame(()=>{setTimeout(()=>{a(),y()},100)})}),setTimeout(()=>{a(),y()},i)})}async function N(t){u(`Processing: ${t.name} (${t.size} bytes)`);try{try{e.FS.unlink("/in.epk")}catch{}try{e.FS.rmdir("/out")}catch{}let n=new Uint8Array(await t.arrayBuffer());e.FS.writeFile("/in.epk",n);let r=["x","/in.epk","-o/out","-y","-bb0"];await e.callMain(r);let i=e.FS.readdir("/out").filter(l=>l!=="."&&l!==".."),s=i.find(l=>l.toLowerCase()==="cert.txt");if(!s)return u("\u26A0\uFE0F cert.txt not found. Returning original archive unchanged."),{name:t.name,blob:null,changed:!1};let c=e.FS.readFile(`/out/${s}`),f=new TextDecoder("utf-8").decode(c),a=M(f);if(a!==f){e.FS.writeFile(`/out/${s}`,new TextEncoder().encode(a)),u("Updated cert.txt: ensured trailing newline.");try{e.FS.unlink("/fixed.epk")}catch{}let l=["a","/fixed.epk","-bb0"];for(let S of i)l.push(`/out/${S}`);await e.callMain(l);let h=e.FS.readFile("/fixed.epk"),y=new Blob([h],{type:"application/octet-stream"});u("\u2705 Done. Ready for download.");try{let S=e.FS.readdir("/out").filter(o=>o!=="."&&o!=="..");for(let o of S)try{e.FS.unlink(`/out/${o}`)}catch{}try{e.FS.rmdir("/out")}catch{}}catch{}try{e.FS.unlink("/fixed.epk")}catch{}try{e.FS.unlink("/in.epk")}catch{}return{name:A(t.name,"fixed"),blob:y,changed:!0}}else return u("\u2705 No change needed: cert.txt already ends with a newline."),{name:t.name,blob:null,changed:!1}}catch(n){return u("Error: "+(n?.message||n)),{name:t.name,blob:null,changed:!1}}}async function W(t){let n=new Uint8Array(t);return Array.from(n).map(r=>r.toString(16).padStart(2,"0")).join("")}async function E(t){u(`Combining ${t.length} .epk files into one package`);let n="/combine";try{e.FS.rmdir(n)}catch{}try{e.FS.mkdir(n)}catch{}let r=`${n}/inner`;try{e.FS.rmdir(r)}catch{}try{e.FS.mkdir(r)}catch{}let i=0;for(let o of Array.from(t)){i++;let d=`${n}/in${i}.epk`;try{e.FS.unlink(d)}catch{}let F=new Uint8Array(await o.arrayBuffer());e.FS.writeFile(d,F),await e.callMain(["x",d,`-o${n}/out${i}`,"-y","-bb0"]);let T=e.FS.readdir(`${n}/out${i}`).filter(m=>m!=="."&&m!=="..").find(m=>m==="SM800A_Upgrade_Source.7z");if(!T){u(`\u26A0\uFE0F File ${o.name} missing SM800A_Upgrade_Source.7z \u2014 skipping`);continue}let D=e.FS.readFile(`${n}/out${i}/${T}`),$=`${n}/inner_${i}.7z`;try{e.FS.unlink($)}catch{}e.FS.writeFile($,D);let w=`${n}/inner_out${i}`;try{e.FS.rmdir(w)}catch{}try{e.FS.mkdir(w)}catch{}await e.callMain(["x",$,`-o${w}`,"-y","-bb0"]);let P=e.FS.readdir(w).filter(m=>m!=="."&&m!=="..");for(let m of P){let z=e.FS.readFile(`${w}/${m}`),L=m;e.FS.readdir(r).includes(m)&&(L=`${i}_${m}`),e.FS.writeFile(`${r}/${L}`,z)}}let s=`${n}/SM800A_Upgrade_Source.7z`;try{e.FS.unlink(s)}catch{}let c=e.FS.readdir(r).filter(o=>o!=="."&&o!=="..");if(c.length===0){u("No inner files collected \u2014 aborting combine.");return}let f=["a",s];for(let o of c)f.push(`${r}/${o}`);await e.callMain(f.concat(["-bb0"]));let a=e.FS.readFile(s),g=await crypto.subtle.digest("SHA-256",a),h=`${await W(g)} SM800A_Upgrade_Source.7z
`;e.FS.writeFile(`${n}/cert.txt`,new TextEncoder().encode(h));try{e.FS.unlink("/combined.epk")}catch{}e.FS.writeFile(`${n}/SM800A_Upgrade_Source.7z`,a),await e.callMain(["a","/combined.epk",`${n}/SM800A_Upgrade_Source.7z`,`${n}/cert.txt`,"-y","-bb0"]);let y=e.FS.readFile("/combined.epk"),S=`EPK_Package_${new Date().toISOString().replace(/[:.]/g,"-").replace(/T/,"_").slice(0,19)}.epk`;await _(new Blob([y],{type:"application/octet-stream"}),S),u("\u2705 Combined EPK ready for download: "+S);try{let o=e.FS.readdir(r).filter(d=>d!=="."&&d!=="..");for(let d of o)try{e.FS.unlink(`${r}/${d}`)}catch{}try{e.FS.rmdir(r)}catch{}}catch{}for(let o=1;o<=t.length;o++){try{let d=`${n}/out${o}`,F=e.FS.readdir(d).filter(p=>p!=="."&&p!=="..");for(let p of F)try{e.FS.unlink(`${d}/${p}`)}catch{}try{e.FS.rmdir(d)}catch{}}catch{}try{e.FS.unlink(`${n}/inner_${o}.7z`)}catch{}try{let d=`${n}/inner_out${o}`,F=e.FS.readdir(d).filter(p=>p!=="."&&p!=="..");for(let p of F)try{e.FS.unlink(`${d}/${p}`)}catch{}try{e.FS.rmdir(d)}catch{}}catch{}try{e.FS.unlink(`${n}/in${o}.epk`)}catch{}}try{e.FS.unlink(s)}catch{}try{e.FS.unlink(`${n}/SM800A_Upgrade_Source.7z`)}catch{}try{e.FS.unlink(`${n}/cert.txt`)}catch{}try{e.FS.unlink("/combined.epk")}catch{}try{e.FS.rmdir(n)}catch{}}var b=document.getElementById("drop"),j=document.getElementById("file");["dragenter","dragover"].forEach(t=>b.addEventListener(t,n=>{n.preventDefault(),b.classList.add("drag")}));["dragleave","drop"].forEach(t=>b.addEventListener(t,n=>{n.preventDefault(),b.classList.remove("drag")}));b.addEventListener("drop",t=>{let n=t.dataTransfer&&t.dataTransfer.files?t.dataTransfer.files:null;n&&x(n,{fixOne:N,combineMulti:E,autoDownload:_,singleOutNamer:()=>k()}).catch(r=>u("Error: "+r.message))});j.addEventListener("change",t=>{let n=t.target.files;n&&(n.length>1?E(n).catch(r=>u("Error: "+(r?.message||r))):x(n,{fixOne:N,combineMulti:E,autoDownload:_,singleOutNamer:()=>k()}).catch(r=>u("Error: "+r.message)))});window.__PLAYWRIGHT_TEST__||import("https://esm.run/@sentry/browser").then(t=>{t.init({dsn:"https://34687dbd224e062d40708543ab4ff67a@o106156.ingest.us.sentry.io/4509853489364992"})});"serviceWorker"in navigator&&(location.protocol==="https:"||location.protocol==="http:")&&window.addEventListener("load",()=>{navigator.serviceWorker.register("./sw.js").then(t=>{console.log("ServiceWorker registered with scope:",t.scope)}).catch(t=>{console.warn("ServiceWorker registration failed:",t)})});
</script>
  </body>
</html>
