<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#111626" />
    <link rel="icon" type="image/png" href="icons/icon-192.png" />
    <link rel="apple-touch-icon" href="icons/icon-192.png" />
    <title>EPK fixer</title>
    <style>:root{--ui-scale: 1;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica Neue,Arial,Noto Sans}html{font-size:calc(100% * var(--ui-scale))}body{margin:0;padding:25px;background:#0b0e14;color:#e6e6e6;line-height:1.5;font-size:1rem}p{margin-top:.3125rem}h1{font-size:1.25rem;margin:0 0 .625rem}h2{font-size:1.125rem;margin:0 0 .625rem}a{color:#a7b1c2;text-decoration:none}a:hover{text-decoration:underline}.app{max-width:54rem;margin:0 auto;display:grid;gap:1rem}header{display:flex;flex-wrap:wrap}header h1{flex:1;margin-left:5px}footer{max-width:54rem;color:#a7b1c2;font-size:.8125rem;display:flex;flex-wrap:wrap;gap:.5rem .75rem;align-items:baseline;justify-content:center;text-align:center}footer .copyright{white-space:nowrap}@media (max-width: 520px){footer .disclaimer{flex-basis:100%}}.card{background:#111626;border:1px solid #1c2440;border-radius:.875rem;padding:1rem;box-shadow:0 .375rem 1.125rem #00000040}.row{display:grid;gap:16px}.drop{border:.125rem dashed #29407f;border-radius:.875rem;padding:1.625rem;background:#0f1424;text-align:center}.drop.drag{background:#12204a}.badge{display:flex;justify-content:center;padding:.2rem .6rem;border-radius:999px;background:#1f2848;border:1px solid #33407a;font-size:.75rem;margin-bottom:.625rem}.muted{color:#a7b1c2;font-size:.875rem}.log{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:.75rem;white-space:pre-wrap;background:#0f1424;padding:.75rem;border-radius:.625rem;border:1px solid #253157;max-height:15rem;overflow:auto}input[type=file]{display:none}.btn{display:inline-flex;align-items:center;gap:.5rem;background:#2344ff;border:1px solid #2344ff;color:#fff;border-radius:.625rem;margin-top:.3125rem;padding:.5em 1em;cursor:pointer}@media (max-width: 600px){:root{--ui-scale: 1.0625}body{margin:0;padding:10px}}
</style>
    <script
      defer
      src="https://cloud.umami.is/script.js"
      data-website-id="ba8ead4f-31db-45e1-bbcc-d1c7deb88b2f"
      data-domains="xsandor.github.io"
    ></script>
  </head>
  <body>
    <div class="app">
      <div class="card">
        <header>
          <img src="icons/icon-32.png" height="32" />
          <h1>EPK fixer</h1>
          <span class="badge" id="engineStatus">Engine: not loaded</span>
        </header>
        <p class="muted">
          Drop one or more <code>.epk</code> files below. We'll ensure
          compatibility with AK-SM 800A v4.3.1, then instantly download the
          fixed .epk file.
        </p>
        <p class="muted">All processing happens locally in your browser.</p>
        <div id="drop" class="drop">
          <strong>Drop file(s) here</strong>
          <br /><span class="muted">or</span><br />
          <label class="btn" for="file">Choose file(s)</label>
          <input id="file" type="file" accept=".epk,.ed3,.ed4" multiple />
        </div>
        <p class="muted" style="margin-top: 1rem">
          <strong>Tip:</strong> Upload one <code>.epk</code> to fix it, or
          multiple <code>.epk</code> files to combine them into a single fixed
          package. It is also possible to upload one or several
          <code>.ed3/.ed4</code> files to create a new <code>.epk</code>. Or
          even provide a mix of <code>.epk</code> and
          <code>.ed3/.ed4</code> files, this will also result in a
          <code>.epk</code> that includes all provided files.
        </p>
      </div>
      <div class="card">
        <h2>Log</h2>
        <div id="log" class="log"></div>
      </div>
      <footer>
        <span class="copyright">Â© 2025 Alexander Schmidt.</span>
        <span class="disclaimer"
          >This tool is provided as-is, without warranty of any kind. Use at
          your own risk.</span
        >
      </footer>
    </div>
    <script type="module">function C(){try{return!(!("noModule"in document.createElement("script"))||typeof TextEncoder>"u"||typeof TextDecoder>"u"||typeof Uint8Array>"u"||typeof ArrayBuffer>"u"||typeof Blob>"u"||typeof URL>"u"||typeof URL.createObjectURL!="function"||typeof File>"u"||!("ondrop"in document.createElement("div"))||typeof Promise>"u")}catch{return!1}}function A(t,n){let r=t.lastIndexOf(".");if(r>0){let a=t.slice(0,r),s=t.slice(r);return`${a}_${n}${s}`}throw new Error("Input filename must have an extension")}function B(t){return t.endsWith(`
`)?t:t.replace(/(?:\n?\r?)?$/,"")+`
`}async function U(t,{fixOne:n,combineMulti:r,autoDownload:a}){let s=Array.from(t||[]);if(s.length!==0){if(s.length===1){let l=s[0];if(!(l&&l.name?l.name.toLowerCase():"").endsWith(".epk")&&typeof r=="function"){await r(t),window.umami.track("fix-multiple-epk",{fileCount:t.length});return}let c=await n(l);c&&c.blob&&c.name&&c.changed&&(await a(c.blob,c.name),window.umami.track("fix-single-epk"));return}if(typeof r=="function"){await r(t),window.umami.track("fix-multiple-epk",{fileCount:t.length});return}}}C()||(document.body.innerHTML='<div style="padding:32px;max-width:600px;margin:40px auto;background:#111626;color:#e6e6e6;border-radius:14px;text-align:center;font-size:18px;">\u26A0\uFE0F Your browser is not supported.<br>Please update to the latest version of Chrome, Edge, Firefox, or Safari.</div>');var H="EPK Fixer",g="SM800A_Upgrade_Source.7z",$="cert.txt",y="combined.epk";function W(){return window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone===!0}function N(){W()?document.title="":document.title=H}var z=window.matchMedia("(display-mode: standalone)");z.addEventListener?.("change",()=>N());N();var{default:j}=await import("https://cdn.jsdelivr.net/npm/7z-wasm@1.2.0/+esm"),e=await j({print:()=>{}}),x=document.getElementById("log");function f(t){x.textContent+=x.textContent?`
`+t:t,x.scrollTop=x.scrollHeight}var D=document.getElementById("engineStatus");D.textContent="Engine: ready (7z-wasm)";D.style.background="#1e3a1e";f("Ready, please provide file(s) for processing!");async function P(t,n,r={}){let{maxDelay:a=2e3}=r,s=URL.createObjectURL(t),l=document.createElement("a");l.style.display="none",l.href=s,l.download=n,document.body.appendChild(l);let p=!1,c=()=>{if(!p){p=!0;try{URL.revokeObjectURL(s)}catch{}try{l.remove()}catch{}document.removeEventListener("visibilitychange",b,!0),window.removeEventListener("pagehide",m,!0),window.removeEventListener("blur",w,!0)}},b=()=>{document.visibilityState==="hidden"&&c()},m=()=>c(),w=()=>{c()};return document.addEventListener("visibilitychange",b,!0),window.addEventListener("pagehide",m,!0),window.addEventListener("blur",w,!0),l.click(),new Promise(F=>{requestAnimationFrame(()=>{requestAnimationFrame(()=>{setTimeout(()=>{c(),F()},100)})}),setTimeout(()=>{c(),F()},a)})}async function K(t){f(`Processing: ${t.name} (${t.size} bytes)`);try{try{e.FS.unlink("/in.epk")}catch{}try{e.FS.rmdir("/out")}catch{}let n=new Uint8Array(await t.arrayBuffer());e.FS.writeFile("/in.epk",n);let r=["x","/in.epk","-o/out","-y","-bb0"];await e.callMain(r);let a=e.FS.readdir("/out").filter(m=>m!=="."&&m!==".."),s=a.find(m=>m.toLowerCase()===$);if(!s)return f(`\u26A0\uFE0F ${$} not found. Returning original archive unchanged.`),{name:t.name,blob:null,changed:!1};let l=e.FS.readFile(`/out/${s}`),p=new TextDecoder("utf-8").decode(l),c=B(p);if(c!==p){e.FS.writeFile(`/out/${s}`,new TextEncoder().encode(c)),f(`Updated ${$}: ensured trailing newline.`);try{e.FS.unlink(`/${y}`)}catch{}let m=["a",`/${y}`,"-bb0"];for(let h of a)m.push(`/out/${h}`);await e.callMain(m);let w=e.FS.readFile(`/${y}`),F=new Blob([w],{type:"application/octet-stream"});f("\u2705 Done. Ready for download.");try{let h=e.FS.readdir("/out").filter(i=>i!=="."&&i!=="..");for(let i of h)try{e.FS.unlink(`/out/${i}`)}catch{}try{e.FS.rmdir("/out")}catch{}}catch{}try{e.FS.unlink(`/${y}`)}catch{}try{e.FS.unlink("/in.epk")}catch{}return{name:A(t.name,"fixed"),blob:F,changed:!0}}else return f(`\u2705 No change needed: ${$} already ends with a newline.`),{name:t.name,blob:null,changed:!1}}catch(n){return f("Error: "+(n?.message||n)),{name:t.name,blob:null,changed:!1}}}async function Z(t){let n=new Uint8Array(t);return Array.from(n).map(r=>r.toString(16).padStart(2,"0")).join("")}async function Y(t){f(`Creating .epk from ${t.length} ${t.length>1?"files":"file"}.`);let n="/combine";try{e.FS.rmdir(n)}catch{}try{e.FS.mkdir(n)}catch{}let r=`${n}/inner`;try{e.FS.rmdir(r)}catch{}try{e.FS.mkdir(r)}catch{}let a=0;for(let i of Array.from(t)){a++;let o=i.name||`file${a}`,S=o.toLowerCase();if(S.endsWith(".ed3")||S.endsWith(".ed4")){try{let d=new Uint8Array(await i.arrayBuffer()),E=o;e.FS.readdir(r).includes(o)&&(E=`${a}_${o}`),e.FS.writeFile(`${r}/${E}`,d)}catch(d){f(`\u26A0\uFE0F Failed to add inner file ${o}: ${d?.message||d}`)}continue}let u=`${n}/in${a}.epk`;try{e.FS.unlink(u)}catch{}let M=new Uint8Array(await i.arrayBuffer());e.FS.writeFile(u,M),await e.callMain(["x",u,`-o${n}/out${a}`,"-y","-bb0"]);let T=e.FS.readdir(`${n}/out${a}`).filter(d=>d!=="."&&d!=="..").find(d=>d===g);if(!T){f(`\u26A0\uFE0F File ${i.name} missing ${g} \u2014 skipping`);continue}let I=e.FS.readFile(`${n}/out${a}/${T}`),L=`${n}/inner_${a}.7z`;try{e.FS.unlink(L)}catch{}e.FS.writeFile(L,I);let k=`${n}/inner_out${a}`;try{e.FS.rmdir(k)}catch{}try{e.FS.mkdir(k)}catch{}await e.callMain(["x",L,`-o${k}`,"-y","-bb0"]);let O=e.FS.readdir(k).filter(d=>d!=="."&&d!=="..");for(let d of O){let E=e.FS.readFile(`${k}/${d}`),_=d;e.FS.readdir(r).includes(d)&&(_=`${a}_${d}`),e.FS.writeFile(`${r}/${_}`,E)}}let s=`${n}/${g}`;try{e.FS.unlink(s)}catch{}let l=e.FS.readdir(r).filter(i=>i!=="."&&i!=="..");if(l.length===0){f("No inner files collected \u2014 aborting combine.");return}let p=["a",s];for(let i of l)p.push(`${r}/${i}`);await e.callMain(p.concat(["-bb0"]));let c=e.FS.readFile(s),b=await crypto.subtle.digest("SHA-256",c),w=`${await Z(b)} ${g}
`;e.FS.writeFile(`${n}/${$}`,new TextEncoder().encode(w));try{e.FS.unlink(`/${y}`)}catch{}e.FS.writeFile(`${n}/${g}`,c),await e.callMain(["a",`/${y}`,`${n}/${g}`,`${n}/${$}`,"-y","-bb0"]);let F=e.FS.readFile(`/${y}`),h;t&&t.length===1&&t[0]&&t[0].name?h=`${t[0].name.replace(/\.[^.]+$/,"")}.epk`:h=`EPK_Package_${new Date().toISOString().replace(/[:.]/g,"-").replace(/T/,"_").slice(0,19)}.epk`,await P(new Blob([F],{type:"application/octet-stream"}),h),f("\u2705 .epk ready for download: "+h);try{let i=e.FS.readdir(r).filter(o=>o!=="."&&o!=="..");for(let o of i)try{e.FS.unlink(`${r}/${o}`)}catch{}try{e.FS.rmdir(r)}catch{}}catch{}for(let i=1;i<=t.length;i++){try{let o=`${n}/out${i}`,S=e.FS.readdir(o).filter(u=>u!=="."&&u!=="..");for(let u of S)try{e.FS.unlink(`${o}/${u}`)}catch{}try{e.FS.rmdir(o)}catch{}}catch{}try{e.FS.unlink(`${n}/inner_${i}.7z`)}catch{}try{let o=`${n}/inner_out${i}`,S=e.FS.readdir(o).filter(u=>u!=="."&&u!=="..");for(let u of S)try{e.FS.unlink(`${o}/${u}`)}catch{}try{e.FS.rmdir(o)}catch{}}catch{}try{e.FS.unlink(`${n}/in${i}.epk`)}catch{}}try{e.FS.unlink(s)}catch{}try{e.FS.unlink(`${n}/${g}`)}catch{}try{e.FS.unlink(`${n}/${$}`)}catch{}try{e.FS.unlink(`${n}/${y}`)}catch{}try{e.FS.rmdir(n)}catch{}}var v=document.getElementById("drop"),q=document.getElementById("file");["dragenter","dragover"].forEach(t=>v.addEventListener(t,n=>{n.preventDefault(),v.classList.add("drag")}));["dragleave","drop"].forEach(t=>v.addEventListener(t,n=>{n.preventDefault(),v.classList.remove("drag")}));var G=()=>({fixOne:K,combineMulti:Y,autoDownload:P});function R(t){t&&U(t,G()).catch(n=>f("Error: "+(n?.message||n)))}v.addEventListener("drop",t=>{t.preventDefault();let n=t?.dataTransfer?.files??null;R(n)});q.addEventListener("change",t=>{let n=t?.target?.files??null;R(n)});window.__PLAYWRIGHT_TEST__||import("https://esm.run/@sentry/browser").then(t=>{t.init({dsn:"https://34687dbd224e062d40708543ab4ff67a@o106156.ingest.us.sentry.io/4509853489364992"})});"serviceWorker"in navigator&&(location.protocol==="https:"||location.protocol==="http:")&&window.addEventListener("load",()=>{navigator.serviceWorker.register("./sw.js").then(t=>{console.log("ServiceWorker registered with scope:",t.scope)}).catch(t=>{console.warn("ServiceWorker registration failed:",t)})});
</script>
  </body>
</html>
